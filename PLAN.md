# Space Mine Crafter — технический план и архитектура

## Цели реализации
- PixiJS + TypeScript как основа рендера и игровой логики.
- React используется **только** для сложного UI мета-экрана: меню/вкладки/дерево улучшений/крафт/квесты + нижняя панель (Level selector + Go to mine) как оверлей поверх canvas.
- PixiJS отвечает за уровень (корабль/астероиды/враги/эффекты) и **HUD во время уровня**.
- Чёткое разделение: Game Core (движок/симуляция) ↔ UI ↔ Persisted Progress.
- Все gameplay-параметры в одном конфиге констант.
- Строгая типизация, минимум магии, предсказуемые зависимости.

## Рекомендуемый стек (npm)
### Рендер/игра
- `pixi.js` — 2D renderer + сцена.
- (опционально) `@pixi/ui` — UI-виджеты Pixi (HUD в рантайме уровня: HP/топливо/лут и т.п.).
- (опционально) `gsap` или `tweedle.js` — твины/анимации (warp-in, всплывающие числа, UI-переходы).
- `howler` — звук/музыка.

### Приложение/меню/UI
- `react`, `react-dom` — **только сложный UI меню**: вкладки Update/Craft/Quests, дерево улучшений, крафт, квесты, нижняя панель (селектор уровня + кнопка старта).
- `zustand` — лёгкое управление состоянием (progress + runtime).
- (опционально) `immer` — удобные иммутабельные апдейты, если нужно.

### Сохранения
- `zod` — схемы и валидация сохранений (миграции версий).
- `localforage` — хранение прогресса (IndexedDB/WebSQL/localStorage), надёжнее чистого localStorage.

### Инструменты
- `vite` — сборка/дев-сервер, быстрый HMR.
- `typescript`
- `eslint`, `prettier`
- `vitest` — тесты (в первую очередь: экономику/баланс/формулы/валидацию save).
- (опционально) `@types/*` — типы где нужны.

## Архитектура модулей (предлагаемая)
### 1) `src/game/` — игровой runtime (Pixi)
- `GameApp`:
  - инициализация Pixi Application, загрузка ассетов, создание сцен, тик-луп.
- Сцены:
  - `MenuScene` (опционально; если решим переносить меню в Pixi. По текущему плану меню — в React.)
  - `RunScene` (уровень: корабль, астероиды, враги, босс)
- ECS-подход (лёгкий) или entity-manager:
  - `entities/` (Ship, Asteroid, Enemy, Boss, Bullet, Pickup)
  - `systems/`:
    - input (мышь/клавиатура)
    - movement/physics (инерция)
    - aiming (поворот к курсору)
    - shooting + cooldowns
    - collisions
    - damage/health
    - spawn director (asteroids/enemies/boss)
    - loot drop + pickups
    - fuel system + run end conditions
- Компоненты Pixi:
  - `sprites/`, `effects/` (warp effect, explosions, hit flash, trails)
  - `hud/` (Pixi HUD во время уровня: HP/топливо/текущий лут; можно на `@pixi/ui` или кастомно на Pixi Container/Text)

### 2) `src/ui/` — React UI
- `AppShell`:
  - Canvas (Pixi) как нижний слой.
  - React UI как оверлей (**только меню/панели мета-прогрессии**, без HUD уровня).
- Вкладки:
  - `UpdateTab` — дерево улучшений (визуализация графа, блокировка/раскрытие)
  - `CraftTab` — рецепты, требования, крафт
  - `QuestsTab` — список квестов, прогресс, награды
- Общие элементы:
  - нижняя панель: `LevelSelector` + кнопка `GoToMine` (всегда видны в меню)

### 3) `src/progression/` — мета-прогрессия
- Модель:
  - `UpgradesGraph` (описание узлов/веток/стоимости/требований)
  - `CraftRecipes`
  - `Quests`
- Логика:
  - покупка апгрейдов, проверка доступности, расчёт стоимости
  - применение апгрейдов к статам корабля (derive stats)
  - награды квестов
- Баланс:
  - функции для дропа/стоимости/скейлинга по уровню

### 4) `src/persistence/` — сохранения
- `saveSchema` (zod): версия, прогресс, открытые уровни, купленные апгрейды, инвентарь.
- `loadSave()` / `saveGame()`
- миграции по `saveVersion` (чтобы можно было менять структуру без вайпа)

### 5) `src/config/` — все игровые константы
- `gameConfig.ts`:
  - движение (accel, maxSpeed, damping)
  - расход топлива (perSecond, perAcceleration, perShot если надо)
  - HP/урон/скорострельность
  - спавн: частоты, лимиты, рост сложности по levelId
  - дроп: минералы (min/max), шанс скрапа, модификаторы
  - цены апгрейдов и формулы роста
  - параметры босса (фазы, cooldowns, плотность атак)
- Требование: **каждая константа подписана комментарием “что делает и на что влияет”.**

## Состояния игры (state machine)
- `BOOT` → загрузка ассетов
- `MENU` → вкладки + выбор уровня
- `RUN_WARP_IN` → анимация появления
- `RUN_PLAYING` → симуляция
- `RUN_END`:
  - успех (boss killed) → выдача наград → unlock next level → MENU
  - неуспех (fuel=0 или hp=0) → выдача добычи → MENU

## Правила геймплея (MVP → затем расширение)
### MVP (чтобы “игралось”)
- Меню с 3 вкладками (простые заглушки UI допустимы).
- Дерево улучшений: 1–2 ветки, раскрытие узлов, покупка за минералы.
- Выбор уровня: Level 1 доступен, Level 2 открывается после победы.
- Ран:
  - warp-in
  - астероиды спавнятся, летают
  - корабль: WASD инерция, поворот к мыши, стрельба ЛКМ
  - столкновения/урон/HP
  - топливо тратится, при 0 — выход в меню с добычей
  - выпадение минералов + шанс скрапа
- Сохранение прогресса.

### Потом
- Враги + их пули + дроп
- Босс + фазы и атаки
- Крафт и рецепты
- Квесты
- Баланс и расширение дерева улучшений

## Баланс: как подойти разумно
- Все параметры — в конфиге, без “магических чисел”.
- Формулы скейлинга:
  - стоимость апгрейда: экспонента/квадратичное увеличение по tier
  - HP/урон врагов: плавная прогрессия по levelId
- Метрики для проверки:
  - средняя длительность рана
  - средняя прибыль минералов за ран на каждом уровне
  - частота выпадения скрапа (ожидаемое значение)
  - “время до следующего заметного апгрейда” (не слишком долго)

## Структура проекта (пример)
- `src/`
  - `config/`
  - `game/`
  - `ui/`
  - `progression/`
  - `persistence/`
  - `assets/` (если импортируем через бандлер) или ссылка на внешнюю папку `assets/`
- `index.html` + `main.tsx`

## Нефункциональные требования
- Производительность: ограничение количества сущностей, батчинг спрайтов, аккуратные аллокации.
- Надёжность сохранений: валидация + миграции.
- Расширяемость: новые враги/апгрейды добавляются декларативно (данными), без переписывания логики.

---

## Архитектура (зафиксировано для реализации)
### Граница ответственности PixiJS vs React
- PixiJS:
  - уровень: корабль/астероиды/враги/эффекты
  - HUD уровня (HP/Fuel/текущий лут/прочее)
- React (оверлей поверх canvas):
  - меню и мета-прогрессия: вкладки Update/Craft/Quests
  - дерево улучшений, UI крафта, UI квестов
  - нижняя панель: селектор уровня + кнопка Go to mine (всегда доступна в меню)

### Слои и направления зависимостей
- `src/game/**` (runtime) может читать/писать в `src/state/**` (zustand store) и читать `src/config/**`.
- `src/ui/**` (React) может читать/писать в `src/state/**` и читать `src/progression/**`.
- `src/progression/**` содержит “данные и правила” мета-прогрессии (апгрейды/рецепты/квесты), без зависимости от Pixi/React.
- `src/persistence/**` отвечает за загрузку/сохранение прогресса и миграции.

## Чеклист полной реализации (отмечаем прогресс)
### 0) Основа проекта
- [x] Vite + React + TypeScript каркас
- [x] Подключены зависимости (PixiJS/React/zustand/и т.д.)
- [x] Настроены scripts: dev/build/lint/format
- [x] ESLint работает (минимально достаточно)

### 1) Интеграция React ↔ Pixi (каркас)
- [x] `AppShell`: Pixi canvas как базовый слой
- [x] React-меню как оверлей поверх canvas
- [x] Флоу: Menu → Go to mine → RunScene
- [x] RunScene: warp-in + HUD-заглушка

### 2) Меню (MVP)
- [x] Вкладки Update/Craft/Quests (заглушки UI)
- [x] Нижняя панель с селектором уровня и Go to mine
- [x] Реальное дерево улучшений (граф, раскрытие, покупка)
- [x] Реальный баланс цен/прогрессии дерева

### 3) Уровень: управление и базовые системы (MVP → полноценная игра)
- [x] Управление кораблём: WASD + инерция (ускорение/демпфирование)
- [x] Поворот корабля к курсору
- [x] Стрельба ЛКМ (пули, скорострельность, урон)
- [x] Астероиды: спавн, хаотичное движение, HP
- [x] Разрушение астероидов: эффекты, дроп минералов + шанс скрапа
- [x] Сбор лута (pickup + притяжение/коллизии)
- [x] Топливо: расход от движения, расход в секунду, завершение рана при 0
- [x] HUD уровня: полноценные UI-полосы для HP/Fuel (и Shield при наличии)
- [x] Урон от столкновений: на старте смертельно (конфигом)
- [x] Завершение рана: экран итогов (причина/статистика/к улучшениям/рестарт) + перенос добычи в прогресс

### 4) Враги и бой (после MVP астероидов)
- [x] Спавн врагов по прогрессу (kill-count/time)
- [x] AI врагов (преследование/держать дистанцию/паттерны)
- [x] Пули врагов, попадания, урон
- [x] Дроп с врагов (больше минералов/скрапа)

### 5) Босс и прохождение уровня
- [x] Директор уровня: появление босса после условия
- [x] Босс: несколько атак/телеграфы/фазы
- [x] Условие победы: убийство босса
- [x] Unlock следующего уровня после победы

### 6) Мета-прогрессия (полноценная)
- [x] Модель апгрейдов (дерево) + требования открытия
- [x] Применение апгрейдов к статам корабля (derive stats)
- [x] Экономика: цены/дроп/темп апгрейдов (баланс)

### 7) Крафт и квесты (заложено, но пока не делаем)
- [ ] Craft: модель рецептов + инвентарь скрапа/минералов
- [ ] Craft UI: список рецептов, требования, крафт
- [ ] Quests: модель квестов + прогресс + награды
- [ ] Quests UI: список квестов и выдача наград

### 8) Сохранение прогресса
- [x] Save schema (zod) + версия
- [x] `loadSave()/saveGame()` (localforage)
- [x] Миграции save-версий
- [x] Автосохранение при важных событиях (покупка апгрейда/конец рана)