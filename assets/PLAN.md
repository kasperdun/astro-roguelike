# Space Mine Crafter — технический план и архитектура

## Цели реализации
- PixiJS + TypeScript как основа рендера и игровой логики.
- React используется **только** для сложного UI мета-экрана: меню/вкладки/дерево улучшений/крафт/квесты + нижняя панель (Level selector + Go to mine) как оверлей поверх canvas.
- PixiJS отвечает за уровень (корабль/астероиды/враги/эффекты) и **HUD во время уровня**.
- Чёткое разделение: Game Core (движок/симуляция) ↔ UI ↔ Persisted Progress.
- Все gameplay-параметры в одном конфиге констант.
- Строгая типизация, минимум магии, предсказуемые зависимости.

## Рекомендуемый стек (npm)
### Рендер/игра
- `pixi.js` — 2D renderer + сцена.
- (опционально) `@pixi/ui` — UI-виджеты Pixi (HUD в рантайме уровня: HP/топливо/лут и т.п.).
- (опционально) `gsap` или `tweedle.js` — твины/анимации (warp-in, всплывающие числа, UI-переходы).
- `howler` — звук/музыка.

### Приложение/меню/UI
- `react`, `react-dom` — **только сложный UI меню**: вкладки Update/Craft/Quests, дерево улучшений, крафт, квесты, нижняя панель (селектор уровня + кнопка старта).
- `zustand` — лёгкое управление состоянием (progress + runtime).
- (опционально) `immer` — удобные иммутабельные апдейты, если нужно.

### Сохранения
- `zod` — схемы и валидация сохранений (миграции версий).
- `localforage` — хранение прогресса (IndexedDB/WebSQL/localStorage), надёжнее чистого localStorage.

### Инструменты
- `vite` — сборка/дев-сервер, быстрый HMR.
- `typescript`
- `eslint`, `prettier`
- `vitest` — тесты (в первую очередь: экономику/баланс/формулы/валидацию save).
- (опционально) `@types/*` — типы где нужны.

## Архитектура модулей (предлагаемая)
### 1) `src/game/` — игровой runtime (Pixi)
- `GameApp`:
  - инициализация Pixi Application, загрузка ассетов, создание сцен, тик-луп.
- Сцены:
  - `MenuScene` (опционально; если решим переносить меню в Pixi. По текущему плану меню — в React.)
  - `RunScene` (уровень: корабль, астероиды, враги, босс)
- ECS-подход (лёгкий) или entity-manager:
  - `entities/` (Ship, Asteroid, Enemy, Boss, Bullet, Pickup)
  - `systems/`:
    - input (мышь/клавиатура)
    - movement/physics (инерция)
    - aiming (поворот к курсору)
    - shooting + cooldowns
    - collisions
    - damage/health
    - spawn director (asteroids/enemies/boss)
    - loot drop + pickups
    - fuel system + run end conditions
- Компоненты Pixi:
  - `sprites/`, `effects/` (warp effect, explosions, hit flash, trails)
  - `hud/` (Pixi HUD во время уровня: HP/топливо/текущий лут; можно на `@pixi/ui` или кастомно на Pixi Container/Text)

### 2) `src/ui/` — React UI
- `AppShell`:
  - Canvas (Pixi) как нижний слой.
  - React UI как оверлей (**только меню/панели мета-прогрессии**, без HUD уровня).
- Вкладки:
  - `UpdateTab` — дерево улучшений (визуализация графа, блокировка/раскрытие)
  - `CraftTab` — рецепты, требования, крафт
  - `QuestsTab` — список квестов, прогресс, награды
- Общие элементы:
  - нижняя панель: `LevelSelector` + кнопка `GoToMine` (всегда видны в меню)

### 3) `src/progression/` — мета-прогрессия
- Модель:
  - `UpgradesGraph` (описание узлов/веток/стоимости/требований)
  - `CraftRecipes`
  - `Quests`
- Логика:
  - покупка апгрейдов, проверка доступности, расчёт стоимости
  - применение апгрейдов к статам корабля (derive stats)
  - награды квестов
- Баланс:
  - функции для дропа/стоимости/скейлинга по уровню

### 4) `src/persistence/` — сохранения
- `saveSchema` (zod): версия, прогресс, открытые уровни, купленные апгрейды, инвентарь.
- `loadSave()` / `saveGame()`
- миграции по `saveVersion` (чтобы можно было менять структуру без вайпа)

### 5) `src/config/` — все игровые константы
- `gameConfig.ts`:
  - движение (accel, maxSpeed, damping)
  - расход топлива (perSecond, perAcceleration, perShot если надо)
  - HP/урон/скорострельность
  - спавн: частоты, лимиты, рост сложности по levelId
  - дроп: минералы (min/max), шанс скрапа, модификаторы
  - цены апгрейдов и формулы роста
  - параметры босса (фазы, cooldowns, плотность атак)
- Требование: **каждая константа подписана комментарием “что делает и на что влияет”.**

## Состояния игры (state machine)
- `BOOT` → загрузка ассетов
- `MENU` → вкладки + выбор уровня
- `RUN_WARP_IN` → анимация появления
- `RUN_PLAYING` → симуляция
- `RUN_END`:
  - успех (boss killed) → выдача наград → unlock next level → MENU
  - неуспех (fuel=0 или hp=0) → выдача добычи → MENU

## Правила геймплея (MVP → затем расширение)
### MVP (чтобы “игралось”)
- Меню с 3 вкладками (простые заглушки UI допустимы).
- Дерево улучшений: 1–2 ветки, раскрытие узлов, покупка за минералы.
- Выбор уровня: Level 1 доступен, Level 2 открывается после победы.
- Ран:
  - warp-in
  - астероиды спавнятся, летают
  - корабль: WASD инерция, поворот к мыши, стрельба ЛКМ
  - столкновения/урон/HP
  - топливо тратится, при 0 — выход в меню с добычей
  - выпадение минералов + шанс скрапа
- Сохранение прогресса.

### Потом
- Враги + их пули + дроп
- Босс + фазы и атаки
- Крафт и рецепты
- Квесты
- Баланс и расширение дерева улучшений

## Баланс: как подойти разумно
- Все параметры — в конфиге, без “магических чисел”.
- Формулы скейлинга:
  - стоимость апгрейда: экспонента/квадратичное увеличение по tier
  - HP/урон врагов: плавная прогрессия по levelId
- Метрики для проверки:
  - средняя длительность рана
  - средняя прибыль минералов за ран на каждом уровне
  - частота выпадения скрапа (ожидаемое значение)
  - “время до следующего заметного апгрейда” (не слишком долго)

## Структура проекта (пример)
- `src/`
  - `config/`
  - `game/`
  - `ui/`
  - `progression/`
  - `persistence/`
  - `assets/` (если импортируем через бандлер) или ссылка на внешнюю папку `assets/`
- `index.html` + `main.tsx`

## Нефункциональные требования
- Производительность: ограничение количества сущностей, батчинг спрайтов, аккуратные аллокации.
- Надёжность сохранений: валидация + миграции.
- Расширяемость: новые враги/апгрейды добавляются декларативно (данными), без переписывания логики.